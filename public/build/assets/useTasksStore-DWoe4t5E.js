import{_ as m,H as p}from"./app-CQeDVQuS.js";import{p as a}from"./with-selector-Dx34AVcc.js";import{m as l,r as u}from"./reorder-Cl5rjXcS.js";import{c as _}from"./index-DSj5ND_Q.js";const g=i=>{m.set(i.progress),i.progress===1&&m.done()},k=(i,d)=>({uploadAttachments:async(s,t)=>{const r=d().tasks[s.group_id].findIndex(o=>o.id===s.id);try{const{data:o}=await p.postForm(route("projects.tasks.attachments.upload",[s.project_id,s.id]),{attachments:t.filter(e=>e.id===void 0)},{onUploadProgress:g});return i(a(e=>{e.tasks[s.group_id][r].attachments=[...e.tasks[s.group_id][r].attachments,...o.files]}))}catch(o){console.error(o),alert("Failed to upload attachments")}},deleteAttachment:async(s,t)=>{const r=d().tasks[s.group_id].findIndex(o=>o.id===s.id);try{const o=d().tasks[s.group_id][r].attachments[t].id;return await p.delete(route("projects.tasks.attachments.destroy",[s.project_id,s.id,o]),{progress:!0}),i(a(e=>{e.tasks[s.group_id][r].attachments=[...e.tasks[s.group_id][r].attachments.filter(n=>n.id!==o)]}))}catch(o){console.error(o),alert("Failed to delete attachment")}}}),f=(i,d)=>({comments:[],fetchComments:async(s,t)=>{try{const{data:r}=await p.get(route("projects.tasks.comments",[s.project_id,s.id]));return t(),i(a(o=>{o.comments=r}))}catch(r){t(),console.error(r),alert("Failed to load comments")}},saveComment:async(s,t,r)=>{try{const{data:o}=await p.post(route("projects.tasks.comments.store",[s.project_id,s.id]),{content:t},{progress:!0});return r(),i(a(e=>{e.comments=[o.comment,...e.comments]}))}catch(o){r(),console.error(o),alert("Failed to save comment")}}}),F=i=>{let d=(i%60).toString();return d.length===1&&(d=`0${d}`),`${Math.floor(i/60)}:${d}`},x=i=>{if(i.includes(":"))return i.split(":")[0]*60+parseInt(i.split(":")[1]);if(i.includes(".")){let d=i.split(".")[1];return d.length===1&&(d+="0"),i.split(".")[0]*60+d*.6}else if(i.includes(",")){let d=i.split(",")[1];return d.length===1&&(d+="0"),i.split(",")[0]*60+d*.6}return i*60},w=i=>/^(\d{1,2}:[0-5]{1}[0-9]{1})$|^(\d{1,3}\.\d{0,2})$|^(\d{1,3},\d{0,2})$|^(\d{1,3})$/.test(i),h=(i,d)=>({saveTimeLog:async(s,t)=>{const r=d().tasks[s.group_id].findIndex(o=>o.id===s.id);try{const{data:o}=await p.post(route("projects.tasks.time-logs.store",[s.project_id,s.id]),{minutes:x(t)},{progress:!0});return i(a(e=>{e.tasks[s.group_id][r].time_logs=[...e.tasks[s.group_id][r].time_logs,o.timeLog]}))}catch(o){console.error(o),alert("Failed to save time log")}},deleteTimerLog:async(s,t)=>{const r=d().tasks[s.group_id].findIndex(o=>o.id===s.id);try{return await p.delete(route("projects.tasks.time-logs.destroy",[s.project_id,s.id,t]),{progress:!0}),i(a(o=>{o.tasks[s.group_id][r].time_logs=[...o.tasks[s.group_id][r].time_logs.filter(e=>e.id!==t)]}))}catch(o){console.error(o),alert("Failed to delete time log")}},startTimer:async s=>{const t=d().tasks[s.group_id].findIndex(r=>r.id===s.id);try{const{data:r}=await p.post(route("projects.tasks.time-logs.timer.start",[s.project_id,s.id]),{},{progress:!0});return i(a(o=>{o.tasks[s.group_id][t].time_logs=[...o.tasks[s.group_id][t].time_logs,r.timeLog]}))}catch(r){console.error(r),alert("Failed to start timer")}},stopTimer:async(s,t)=>{const r=d().tasks[s.group_id].findIndex(e=>e.id===s.id),o=d().tasks[s.group_id][r].time_logs.findIndex(e=>e.id===t);try{const{data:e}=await p.post(route("projects.tasks.time-logs.timer.stop",[s.project_id,s.id,t]),{},{progress:!0});return i(a(n=>{n.tasks[s.group_id][r].time_logs[o]={...e.timeLog}}))}catch(e){console.error(e),alert("Failed to stop timer")}}}),T=(i,d)=>({addTaskLocally:s=>i(a(t=>{t.tasks[s.group_id]=[s,...t.tasks[s.group_id]]})),updateTaskLocally:(s,t,r)=>i(a(o=>{const e=d().findTask(s),n=o.tasks[e.group_id].findIndex(c=>c.id===e.id);if(t==="group_id"&&e.group_id!==r){const c=l(o.tasks,e.group_id,r,n,0);o.tasks[e.group_id]=c[e.group_id],o.tasks[r]=c[r],o.tasks[r][0][t]=r}else o.tasks[e.group_id][n][t]=r})),removeTaskLocally:s=>i(a(t=>{const r=d().findTask(s);t.tasks[r.group_id]=t.tasks[r.group_id].filter(o=>o.id!==r.id)})),restoreTaskLocally:(s,t)=>i(a(r=>{r.tasks[s]=[t,...r.tasks[s]].sort((o,e)=>o.order_column>e.order_column?1:-1)})),addCommentLocally:s=>i(a(t=>{t.comments=[s,...t.comments]})),addAttachmentsLocally:s=>i(a(t=>{const r=d().findTask(s[0].task_id),o=t.tasks[r.group_id].findIndex(e=>e.id===r.id);t.tasks[r.group_id][o].attachments=[...t.tasks[r.group_id][o].attachments,...s]})),removeAttachmentLocally:(s,t)=>i(a(r=>{const o=d().findTask(s),e=r.tasks[o.group_id].findIndex(n=>n.id===s);r.tasks[o.group_id][e].attachments=r.tasks[o.group_id][e].attachments.filter(n=>n.id!==t)})),addTimeLogLocally:s=>i(a(t=>{const r=d().findTask(s.task_id),o=t.tasks[r.group_id].findIndex(e=>e.id===r.id);t.tasks[r.group_id][o].time_logs=[...t.tasks[r.group_id][o].time_logs,s]})),removeTimeLogLocally:(s,t)=>i(a(r=>{const o=d().findTask(s),e=r.tasks[o.group_id].findIndex(n=>n.id===s);r.tasks[o.group_id][e].time_logs=r.tasks[o.group_id][e].time_logs.filter(n=>n.id!==t)})),reorderTaskLocally:(s,t,r)=>{const o=u(d().tasks[s],t,r);return i(a(e=>{e.tasks[s]=o}))},moveTaskLocally:(s,t,r,o)=>{const e=l(d().tasks,s,t,r,o);return i(a(n=>{n.tasks[s]=e[s],n.tasks[t]=e[t],n.tasks[t][o]={...n.tasks[t][o],group_id:t}}))}}),S=_((i,d)=>({...k(i,d),...h(i,d),...f(i),...T(i,d),tasks:{},setTasks:s=>i(()=>({tasks:{...s}})),addTask:s=>i(a(t=>{t.tasks[s.group_id].findIndex(o=>o.id===s.id)===-1&&(t.tasks[s.group_id]=[...t.tasks[s.group_id],s])})),findTask:s=>{for(const t in d().tasks){const r=d().tasks[t].find(o=>o.id===s);if(r)return r}return null},updateTaskProperty:async(s,t,r,o=null)=>{try{return await p.put(route("projects.tasks.update",[s.project_id,s.id]),{[t]:r},{progress:!1}),i(a(e=>{const n=e.tasks[s.group_id].findIndex(c=>c.id===s.id);if(t==="group_id"&&s.group_id!==r){const c=l(e.tasks,s.group_id,r,n,0);e.tasks[s.group_id]=c[s.group_id],e.tasks[r]=c[r],e.tasks[r][0][t]=r}else e.tasks[s.group_id][n][t]=o||r}))}catch(e){console.error(e),alert("Failed to save task property change")}},complete:(s,t)=>{const r=t?!0:null,o=d().tasks[s.group_id].findIndex(e=>e.id===s.id);return p.post(route("projects.tasks.complete",[s.project_id,s.id]),{completed:t}).catch(()=>alert("Failed to save task completed action")),i(a(e=>{e.tasks[s.group_id][o].completed_at=r}))},reorderTask:(s,t)=>{const r=+s.droppableId.split("-")[1],o=u(d().tasks[r],s.index,t.index),e={ids:o.map(n=>n.id),group_id:r,from_index:s.index,to_index:t.index};return p.post(route("projects.tasks.reorder",[route().params.project]),e,{progress:!1}).catch(()=>alert("Failed to save task reorder action")),i(a(n=>{n.tasks[r]=o}))},moveTask:(s,t)=>{const r=+s.droppableId.split("-")[1],o=+t.droppableId.split("-")[1],e=l(d().tasks,r,o,s.index,t.index),n={ids:e[o].map(c=>c.id),from_group_id:r,to_group_id:o,from_index:s.index,to_index:t.index};return p.post(route("projects.tasks.move",[route().params.project]),n,{progress:!1}).catch(()=>alert("Failed to save task move action")),i(a(c=>{c.tasks[r]=e[r],c.tasks[o]=e[o]}))}}));export{F as h,w as i,S as u};
