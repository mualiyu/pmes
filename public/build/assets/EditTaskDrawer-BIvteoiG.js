import{r as a,X as M,J as Y,j as t,G as F,a as I}from"./app-CQeDVQuS.js";import{c as m,D as N,a as A}from"./TaskDrawer.module-gYPyq8ht.js";import{R as G}from"./RichTextEditor-DmZzE8jx.js";import{u as L}from"./useTaskDrawerStore-Cjnssq_l.js";import{u as U}from"./useTasksStore-DWoe4t5E.js";import{a as W}from"./useWebSockets-MQGIohH9.js";import{b as k}from"./datetime-BgfhEWkv.js";import H from"./Comments-Brj6w0dB.js";import X from"./LabelsDropdown-CCt45Yav.js";import{P as _}from"./enums-C8PG_d5N.js";import{D as J}from"./Drawer-CB6fJYQ0.js";import{B as V}from"./Breadcrumbs-ClSh7lSV.js";import{T as d}from"./Text-C7Ogcti-.js";import{T as q}from"./TextInput-DWJ4iefM.js";import{S}from"./Select-We5hmp_A.js";import{M as K}from"./MultiSelect-BTwgAEuD.js";import{C as Q}from"./Checkbox-DeGn4I36.js";import"./file-D4aCAaTQ.js";import"./upper-first-sQkIoMXG.js";import"./use-resolved-styles-api-BXRJnP4G.js";import"./use-disclosure-CHrwo5eQ.js";import"./ConfirmModal-6SBIjGeE.js";import"./IconCircleX-D9_CrJfg.js";import"./createReactComponent-Z0-s2Pq0.js";import"./Image-CJlMvM6Z.js";import"./Center-Bqx9e1q2.js";import"./IconX-C26Eg-cJ.js";import"./SimpleGrid-D5dBYODQ.js";import"./get-sorted-breakpoints-iwMx6bI5.js";import"./get-base-value-JqT_q0U7.js";import"./pick-calendar-levels-props-DZFF4eOP.js";import"./use-uncontrolled-DDoK6Wjp.js";import"./AccordionChevron-3X1F-jkk.js";import"./clamp-DTmYCdls.js";import"./InputBase-BmeHhBbi.js";import"./Input-BpqpINKS.js";import"./Popover-CRA-5r7S.js";import"./use-floating-auto-update-DtQKRGxQ.js";import"./noop-BjFrJKj1.js";import"./use-computed-color-scheme-DWNI3ZFj.js";import"./Tooltip-W_kFrwwB.js";import"./get-style-object-DUJZA7T_.js";import"./ColorSwatch-MAR8_92F.js";import"./ColorPicker-CNOY2v1Y.js";import"./ActionIcon-CLNruuHn.js";import"./route-DnWyDX0p.js";import"./_baseClone-CRHU6voy.js";import"./with-selector-Dx34AVcc.js";import"./index-DSj5ND_Q.js";import"./reorder-Cl5rjXcS.js";import"./useTaskGroupsStore-CDXuzMdx.js";import"./Title-DbfSRF69.js";import"./Flex-BgjLIV7l.js";import"./Stack-DnbdV9Zg.js";import"./Avatar-D4Eflhk8.js";import"./Label-B85Huc9I.js";import"./Combobox-CG5rkmIX.js";import"./PillsInput-BdX_zTjY.js";import"./Pill-tisBWBts.js";import"./CheckIcon-D3YounCa.js";import"./OptionsDropdown-D2SabLis.js";import"./get-auto-contrast-value-Da6zqqWm.js";function ar(){var T;const h=a.useRef(null),{edit:s,openEditTask:D,closeEditTask:y}=L(),{initTaskWebSocket:C}=W(),{findTask:v,updateTaskProperty:l,complete:w,deleteAttachment:E,uploadAttachments:O}=U(),{usersWithAccessToProject:p,taskGroups:z,labels:g,openedTask:f,currency:c,auth:{user:Z}}=M().props;a.useEffect(()=>{f&&setTimeout(()=>D(f),50)},[]);const e=v(s.task.id),[i,x]=a.useState({group_id:"",assigned_to_user_id:"",name:"",description:"",pricing_type:_.HOURLY,estimation:0,fixed_price:0,due_on:"",hidden_from_clients:!1,billable:!0,subscribed_users:[],labels:[]});a.useEffect(()=>{if(s.opened)return C(e)},[s.opened]),a.useEffect(()=>{s.opened&&(x({group_id:(e==null?void 0:e.group_id)||"",assigned_to_user_id:(e==null?void 0:e.assigned_to_user_id)||"",name:(e==null?void 0:e.name)||"",description:(e==null?void 0:e.description)||"",pricing_type:(e==null?void 0:e.pricing_type)||_.HOURLY,estimation:(e==null?void 0:e.estimation)||0,fixed_price:e!=null&&e.fixed_price?e.fixed_price/100:0,due_on:e!=null&&e.due_on?Y(e==null?void 0:e.due_on).toDate():"",hidden_from_clients:(e==null?void 0:e.hidden_from_clients)!==void 0?e.hidden_from_clients:!1,billable:(e==null?void 0:e.billable)!==void 0?e.billable:!0,subscribed_users:((e==null?void 0:e.subscribed_users)||[]).map(r=>r.id.toString()),labels:((e==null?void 0:e.labels)||[]).map(r=>r.id)}),setTimeout(()=>{var r;(r=h.current)==null||r.setContent((e==null?void 0:e.description)||"")},300))},[s.opened,e]);const o=(r,n)=>{x({...i,[r]:n});const P=["labels","subscribed_users"],R=["name","description","fixed_price"];if(P.includes(r)){const B={labels:n.map(u=>g.find(b=>b.id===u)),subscribed_users:n.map(u=>p.find(b=>b.id.toString()===u))};l(e,r,n,B[r])}else R.includes(r)||l(e,r,n)},j=r=>{i.name.length>0&&(r==="fixed_price"?l(e,r,i[r]*100):l(e,r,i[r]))};return i.pricing_type,_.FIXED,c!=null&&c.symbol,t.jsx(J,{opened:s.opened,onClose:y,title:t.jsxs(F,{ml:25,my:"sm",wrap:"nowrap",children:[t.jsx(Q,{size:"md",radius:"xl",color:"green",checked:(e==null?void 0:e.completed_at)!==null,onChange:r=>w(e,r.currentTarget.checked),className:can("complete task")?m.checkbox:m.disabledCheckbox}),t.jsxs(d,{fz:I(27),fw:600,lh:1.2,td:(e==null?void 0:e.completed_at)!==null?"line-through":null,children:["#",e==null?void 0:e.number,": ",i.name]})]}),position:"right",size:1e3,overlayProps:{backgroundOpacity:.55,blur:3},transitionProps:{transition:"slide-left",duration:400,timingFunction:"ease"},children:e?t.jsxs(t.Fragment,{children:[t.jsxs(V,{c:"dark.3",ml:24,mb:"xs",separator:"I",separatorMargin:"sm",styles:{separator:{opacity:.3}},children:[t.jsx(d,{size:"xs",children:e.project.name}),t.jsxs(d,{size:"xs",children:["Task #",e.number]}),t.jsxs(d,{size:"xs",children:["Created by ",e.created_by_user.name," on ",k(e.created_at)]})]}),t.jsxs("form",{className:m.inner,children:[t.jsxs("div",{className:m.content,children:[t.jsx(q,{label:"Name",placeholder:"Task name",value:i.name,onChange:r=>o("name",r.target.value),onBlur:()=>j("name"),error:i.name.length===0,readOnly:!can("edit task")}),t.jsx(G,{ref:h,mt:"xl",placeholder:"Task description",content:i.description,height:260,onChange:r=>o("description",r),onBlur:()=>j("description"),readOnly:!can("edit task")}),can("edit task")&&t.jsx(N,{mt:"xl",selected:e.attachments,onChange:r=>O(e,r),remove:r=>E(e,r)}),can("view comments")&&t.jsx(H,{task:e})]}),t.jsxs("div",{className:m.sidebar,children:[t.jsx(S,{label:"Task group",placeholder:"Select task group",allowDeselect:!1,value:i.group_id.toString(),onChange:r=>o("group_id",r),data:z.map(r=>({value:r.id.toString(),label:r.name})),readOnly:!can("edit task")}),t.jsx(S,{label:"Assignee",placeholder:"Select assignee",searchable:!0,mt:"md",value:(T=i.assigned_to_user_id)==null?void 0:T.toString(),onChange:r=>o("assigned_to_user_id",r),data:p.map(r=>({value:r.id.toString(),label:r.name})),readOnly:!can("edit task")}),t.jsx(A,{clearable:!0,valueFormat:"DD MMM YYYY",minDate:new Date,mt:"md",label:"Due date",placeholder:"Pick task due date",value:i.due_on,onChange:r=>o("due_on",r),readOnly:!can("edit task")}),t.jsx(X,{items:g,selected:i.labels,onChange:r=>o("labels",r),mt:"md"}),t.jsx(K,{label:"Subscribers",placeholder:i.subscribed_users.length?null:"Select subscribers",mt:"lg",value:i.subscribed_users,onChange:r=>o("subscribed_users",r),data:p.map(r=>({value:r.id.toString(),label:r.name})),readOnly:!can("edit task")})]})]})]}):t.jsx(t.Fragment,{})})}export{ar as EditTaskDrawer};
